define(["./AxisAlignedBoundingBox-122de82b","./Transforms-73e77b72","./Cartesian2-b4b7b0b3","./when-208fe5b0","./TerrainEncoding-e1b1da20","./Math-8386669c","./OrientedBoundingBox-2e9d8f93","./RuntimeError-7f634f5d","./WebMercatorProjection-1b058022","./createTaskProcessorWorker","./Check-5e798bbf","./AttributeCompression-9711314b","./ComponentDatatype-2da3a966","./WebGLConstants-5e2a49ab","./EllipsoidTangentPlane-69cc10ff","./IntersectionTests-40db2afa","./Plane-b91bfb59"],(function(e,t,i,n,a,r,o,s,u,h,d,c,g,l,m,p,I){"use strict";var E=Uint16Array.BYTES_PER_ELEMENT,f=Int32Array.BYTES_PER_ELEMENT,T=Uint32Array.BYTES_PER_ELEMENT,C=Float32Array.BYTES_PER_ELEMENT,v=Float64Array.BYTES_PER_ELEMENT;function M(e,t,i){i=n.defaultValue(i,r.CesiumMath);for(var a=e.length,o=0;o<a;++o)if(i.equalsEpsilon(e[o],t,r.CesiumMath.EPSILON12))return o;return-1}var b=new i.Cartographic,x=new i.Cartesian3,N=new i.Cartesian3,S=new i.Cartesian3,w=new t.Matrix4;function B(e,a,o,s,u,h,d,c,g,l,m){for(var p=c.length,I=0;I<p;++I){var E=c[I],f=E.cartographic,T=E.index,C=e.length,v=f.longitude,M=f.latitude;M=r.CesiumMath.clamp(M,-r.CesiumMath.PI_OVER_TWO,r.CesiumMath.PI_OVER_TWO),f=f.height-d.skirtHeight;d.hMin=Math.min(d.hMin,f),i.Cartographic.fromRadians(v,M,f,b),l&&(b.longitude+=g),l?I===p-1?b.latitude+=m:0===I&&(b.latitude-=m):b.latitude+=g,M=d.ellipsoid.cartographicToCartesian(b),e.push(M),a.push(f),o.push(i.Cartesian2.clone(o[T])),0<s.length&&s.push(s[T]),0<u.length&&u.push(u[T]),t.Matrix4.multiplyByPoint(d.toENU,M,x),f=d.minimum,M=d.maximum,i.Cartesian3.minimumByComponent(x,f,f),i.Cartesian3.maximumByComponent(x,M,M),M=d.lastBorderPoint,n.defined(M)&&(M=M.index,h.push(M,C-1,C,C,T,M)),d.lastBorderPoint=E}}return h((function(h,d){h.ellipsoid=i.Ellipsoid.clone(h.ellipsoid),h.rectangle=i.Rectangle.clone(h.rectangle);var c=function(h,d,c,g,l,m,p,I,P,A,y){var R,_,W,F,O;_e=n.defined(g)?(R=g.west,_=g.south,W=g.east,F=g.north,O=g.width,g.height):(R=r.CesiumMath.toRadians(l.west),_=r.CesiumMath.toRadians(l.south),W=r.CesiumMath.toRadians(l.east),F=r.CesiumMath.toRadians(l.north),O=r.CesiumMath.toRadians(g.width),r.CesiumMath.toRadians(g.height));var Y,k,U=[_,F],V=[R,W],H=t.Transforms.eastNorthUpToFixedFrame(d,c),L=t.Matrix4.inverseTransformation(H,w);P&&(Y=u.WebMercatorProjection.geodeticLatitudeToMercatorAngle(_),k=1/(u.WebMercatorProjection.geodeticLatitudeToMercatorAngle(F)-Y));var D=1!==m,G=new DataView(h),j=Number.POSITIVE_INFINITY,z=Number.NEGATIVE_INFINITY,q=N;q.x=Number.POSITIVE_INFINITY,q.y=Number.POSITIVE_INFINITY,q.z=Number.POSITIVE_INFINITY;var J=S;J.x=Number.NEGATIVE_INFINITY,J.y=Number.NEGATIVE_INFINITY,J.z=Number.NEGATIVE_INFINITY;var K,Q,X=0,Z=0,$=0;for(Q=0;Q<4;++Q){var ee=X;K=G.getUint32(ee,!0),ee+=T;var te=r.CesiumMath.toRadians(180*G.getFloat64(ee,!0));ee+=v,-1===M(V,te)&&V.push(te),te=r.CesiumMath.toRadians(180*G.getFloat64(ee,!0)),ee+=v,-1===M(U,te)&&U.push(te),ee+=2*v,te=G.getInt32(ee,!0),ee+=f,Z+=te,$+=3*(te=G.getInt32(ee,!0)),X+=K+T}var ie=[],ne=[],ae=new Array(Z),re=new Array(Z),oe=new Array(Z),se=P?new Array(Z):[],ue=D?new Array(Z):[],he=new Array($),de=[],ce=[],ge=[],le=[],me=0,pe=0;for(Q=X=0;Q<4;++Q){K=G.getUint32(X,!0);var Ie=X+=T,Ee=r.CesiumMath.toRadians(180*G.getFloat64(X,!0));X+=v;var fe=r.CesiumMath.toRadians(180*G.getFloat64(X,!0));X+=v;var Te=r.CesiumMath.toRadians(180*G.getFloat64(X,!0)),Ce=.5*Te;X+=v;var ve=r.CesiumMath.toRadians(180*G.getFloat64(X,!0)),Me=.5*ve;X+=v;var be=G.getInt32(X,!0);X+=f;var xe=G.getInt32(X,!0);X+=f,X+=f;for(var Ne=new Array(be),Se=0;Se<be;++Se){var we=Ee+G.getUint8(X++)*Te;b.longitude=we;var Be=fe+G.getUint8(X++)*ve;b.latitude=Be;var Pe=G.getFloat32(X,!0);if(X+=C,0!==Pe&&Pe<y&&(Pe*=-Math.pow(2,A)),Pe*=6371010,b.height=Pe,-1!==M(V,we)||-1!==M(U,Be)){var Ae=M(ie,b,i.Cartographic);if(-1!==Ae){Ne[Se]=ne[Ae];continue}ie.push(i.Cartographic.clone(b)),ne.push(me)}Ne[Se]=me,Math.abs(we-R)<Ce?de.push({index:me,cartographic:i.Cartographic.clone(b)}):Math.abs(we-W)<Ce?ge.push({index:me,cartographic:i.Cartographic.clone(b)}):Math.abs(Be-_)<Me?ce.push({index:me,cartographic:i.Cartographic.clone(b)}):Math.abs(Be-F)<Me&&le.push({index:me,cartographic:i.Cartographic.clone(b)}),j=Math.min(Pe,j),z=Math.max(Pe,z),oe[me]=Pe,Ae=c.cartographicToCartesian(b),ae[me]=Ae,P&&(se[me]=(u.WebMercatorProjection.geodeticLatitudeToMercatorAngle(Be)-Y)*k),D&&(Pe=c.geodeticSurfaceNormal(Ae),ue[me]=Pe),t.Matrix4.multiplyByPoint(L,Ae,x),i.Cartesian3.minimumByComponent(x,q,q),i.Cartesian3.maximumByComponent(x,J,J),we=(we-R)/(W-R),we=r.CesiumMath.clamp(we,0,1),Be=(Be-_)/(F-_),Be=r.CesiumMath.clamp(Be,0,1),re[me]=new i.Cartesian2(we,Be),++me}for(var ye=3*xe,Re=0;Re<ye;++Re,++pe)he[pe]=Ne[G.getUint16(X,!0)],X+=E;if(K!==X-Ie)throw new s.RuntimeError("Invalid terrain tile.")}ae.length=me,re.length=me,oe.length=me,P&&(se.length=me),D&&(ue.length=me);var _e,We=me;l=pe,h={hMin:j,lastBorderPoint:void 0,skirtHeight:I,toENU:L,ellipsoid:c,minimum:q,maximum:J};de.sort((function(e,t){return t.cartographic.latitude-e.cartographic.latitude})),ce.sort((function(e,t){return e.cartographic.longitude-t.cartographic.longitude})),ge.sort((function(e,t){return e.cartographic.latitude-t.cartographic.latitude})),le.sort((function(e,t){return t.cartographic.longitude-e.cartographic.longitude})),B(ae,oe,re,se,ue,he,h,de,-(I=1e-5)*O,!0,-I*_e),B(ae,oe,re,se,ue,he,h,ce,-I*_e,!1),B(ae,oe,re,se,ue,he,h,ge,I*O,!0,I*_e),B(ae,oe,re,se,ue,he,h,le,I*_e,!1),0<de.length&&0<le.length&&(Oe=de[0].index,Ye=le[le.length-1].index,_e=ae.length-1,he.push(Ye,_e,We,We,Oe,Ye)),Z=ae.length;var Fe,Oe=t.BoundingSphere.fromPoints(ae);n.defined(g)&&(Fe=o.OrientedBoundingBox.fromRectangle(g,j,z,c));for(var Ye=new a.EllipsoidalOccluder(c).computeHorizonCullingPointPossiblyUnderEllipsoid(d,ae,j),ke=(g=new e.AxisAlignedBoundingBox(q,J,d),new a.TerrainEncoding(d,g,h.hMin,z,H,!1,P,D,m,p)),Ue=new Float32Array(Z*ke.stride),Ve=0,He=0;He<Z;++He)Ve=ke.encode(Ue,Ve,ae[He],re[He],oe[He],void 0,se[He],ue[He]);return h=de.map((function(e){return e.index})).reverse(),H=ce.map((function(e){return e.index})).reverse(),m=ge.map((function(e){return e.index})).reverse(),p=le.map((function(e){return e.index})).reverse(),H.unshift(m[m.length-1]),H.push(h[0]),p.unshift(h[h.length-1]),p.push(m[0]),{vertices:Ue,indices:new Uint16Array(he),maximumHeight:z,minimumHeight:j,encoding:ke,boundingSphere3D:Oe,orientedBoundingBox:Fe,occludeePointInScaledSpace:Ye,vertexCountWithoutSkirts:We,indexCountWithoutSkirts:l,westIndicesSouthToNorth:h,southIndicesEastToWest:H,eastIndicesNorthToSouth:m,northIndicesWestToEast:p}}(h.buffer,h.relativeToCenter,h.ellipsoid,h.rectangle,h.nativeRectangle,h.exaggeration,h.exaggerationRelativeHeight,h.skirtHeight,h.includeWebMercatorT,h.negativeAltitudeExponentBias,h.negativeElevationThreshold),g=c.vertices;return d.push(g.buffer),h=c.indices,d.push(h.buffer),{vertices:g.buffer,indices:h.buffer,numberOfAttributes:c.encoding.stride,minimumHeight:c.minimumHeight,maximumHeight:c.maximumHeight,boundingSphere3D:c.boundingSphere3D,orientedBoundingBox:c.orientedBoundingBox,occludeePointInScaledSpace:c.occludeePointInScaledSpace,encoding:c.encoding,vertexCountWithoutSkirts:c.vertexCountWithoutSkirts,indexCountWithoutSkirts:c.indexCountWithoutSkirts,westIndicesSouthToNorth:c.westIndicesSouthToNorth,southIndicesEastToWest:c.southIndicesEastToWest,eastIndicesNorthToSouth:c.eastIndicesNorthToSouth,northIndicesWestToEast:c.northIndicesWestToEast}}))}));